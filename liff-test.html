<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>LIFF Test</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>LIFF 測試頁</h1>
  <div id="result"></div>

<script>
// 抓 UTM
function getUTM() {
  const params = new URLSearchParams(window.location.search);
  return {
    utm_source: params.get("utm_source"),
    utm_medium: params.get("utm_medium"),
    utm_campaign: params.get("utm_campaign"),
    utm_content: params.get("utm_content")
  };
}

// 傳資料到 Google Sheet
async function sendDataToSheet(userId, friendFlag) {
  const utm = getUTM();
  await fetch("https://script.google.com/macros/s/AKfycbxqnZaa0_77vGrZtF1hzGjXCPYrkodc-DTGLh6ou19n3Dp0iohJIPQD-YfMUa2bw0UX/exec", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId, friendFlag, ...utm })
  });
}

async function main() {
  await liff.init({ liffId: "2009110865-FvR3qo6e" });

  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: window.location.href });
    return;
  }

  const profile = await liff.getProfile();
  const friendship = await liff.getFriendship();

  document.getElementById("result").innerHTML =
    "userId: " + profile.userId +
    "<br>friendFlag: " + friendship.friendFlag;

  await sendDataToSheet(profile.userId, friendship.friendFlag);
}

main();
</script>
</body>
</html>
